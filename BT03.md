# BT03: Chuyá»ƒn Ä‘á»•i á»©ng dá»¥ng sang TypeScript

## ğŸ“‹ YÃªu cáº§u Ä‘á» bÃ i
- Chuyá»ƒn Ä‘á»•i á»©ng dá»¥ng Express.js tá»« JavaScript sang TypeScript
- Sá»­ dá»¥ng type annotations vÃ  interfaces
- Cáº¥u hÃ¬nh TypeScript compiler (tsconfig.json)
- CÃ i Ä‘áº·t type definitions (@types packages)
- Build vÃ  compile TypeScript code

## âœ… Nhá»¯ng gÃ¬ Ä‘Ã£ thá»±c hiá»‡n

### ğŸ“ Project: `lab03_typescript`
**Nguá»“n:** Chuyá»ƒn Ä‘á»•i tá»« `lab02_mongo_crud`

#### Tech Stack (TypeScript Version)
```json
{
  "typescript": "^5.5.2",         // TypeScript compiler
  "ts-node": "^10.9.1",           // TypeScript execution engine
  "ts-node-dev": "^2.0.0",        // Development auto-reload
  "@types/express": "^4.17.21",   // Express type definitions
  "@types/node": "^20.3.1",       // Node.js type definitions
  "@types/mongoose": "^5.11.97",  // Mongoose type definitions
  "@types/bcryptjs": "^2.4.2",    // bcryptjs type definitions
  "@types/multer": "^1.4.7"       // Multer type definitions
}
```

#### Cáº¥u trÃºc dá»± Ã¡n (chuyá»ƒn Ä‘á»•i)
```
lab03_typescript/
â”œâ”€â”€ package.json              
â”œâ”€â”€ tsconfig.json            # â­ TypeScript configuration
â”œâ”€â”€ .env                      
â”œâ”€â”€ dist/                     # â­ Compiled JavaScript output
â”‚   â””â”€â”€ server.js            # Generated from TypeScript
â”œâ”€â”€ public/
â”‚   â””â”€â”€ uploads/             
â”œâ”€â”€ src/                      # â­ All files now .ts instead of .js
â”‚   â”œâ”€â”€ server.ts            # Entry point (TypeScript)
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ db.ts            
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.model.ts    # â­ With interfaces
â”‚   â”‚   â”œâ”€â”€ role.model.ts    
â”‚   â”‚   â””â”€â”€ position.model.ts 
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ home.controller.ts
â”‚   â”‚   â””â”€â”€ user.controller.ts # â­ Typed Request/Response
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ user.service.ts   
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ user.routes.ts    
â”‚   â””â”€â”€ views/                # EJS templates (unchanged)
â”‚       â”œâ”€â”€ index.ejs        
â”‚       â””â”€â”€ users/
â””â”€â”€ seed/
    â””â”€â”€ seedRolesPositions.ts
```

## ğŸ”§ Chi tiáº¿t Implementation

### 1. TypeScript Configuration
**ğŸ“ File:** `tsconfig.json`

```json
{
    "compilerOptions": {
        "target": "ES2019",                    // ECMAScript version
        "module": "CommonJS",                  // Module system
        "outDir": "dist",                      // Output directory
        "rootDir": "src",                      // Source directory
        "strict": true,                        // Enable all strict type-checking
        "esModuleInterop": true,               // Enable ES module interop
        "skipLibCheck": true,                  // Skip type checking of .d.ts files
        "forceConsistentCasingInFileNames": true  // Enforce case sensitivity
    },
    "include": ["src/**/*"],                   // Files to compile
    "exclude": ["node_modules"]                // Files to exclude
}
```

**Giáº£i thÃ­ch:**
- `strict: true`: Báº­t táº¥t cáº£ type-checking nghiÃªm ngáº·t
- `outDir: "dist"`: Code Ä‘Æ°á»£c compile vÃ o thÆ° má»¥c `dist/`
- `esModuleInterop`: Cho phÃ©p import CommonJS modules theo cÃº phÃ¡p ES6
- `target: "ES2019"`: Transpile vá» ES2019 (compatible vá»›i Node.js 12+)

### 2. Model vá»›i TypeScript Interfaces
**ğŸ“ File:** `src/models/user.model.ts`

```typescript
import mongoose, { Document, Schema } from 'mongoose';

// â­ TypeScript Interface Ä‘á»‹nh nghÄ©a structure cá»§a User
export interface IUser extends Document {
    email: string;
    password: string;
    firstName: string;
    lastName: string;
    address?: string;        // Optional properties vá»›i ?
    phoneNumber?: string;
    gender?: boolean;
    image?: string;
    roleId?: string;
    positionId?: string;
}

// Mongoose Schema (giá»‘ng lab02)
const userSchema: Schema = new Schema(
    {
        email: { type: String, required: true, unique: true },
        password: { type: String, required: true },
        firstName: { type: String, required: true },
        lastName: { type: String, required: true },
        address: { type: String },
        phoneNumber: { type: String },
        gender: { type: Boolean, default: true },
        image: { type: String },
        roleId: { type: String, default: 'R1' },
        positionId: { type: String, default: 'P0' },
    },
    { timestamps: true }
);

// Export model vá»›i generic type IUser
export default mongoose.model<IUser>('User', userSchema);
```

**So sÃ¡nh vá»›i JavaScript (lab02):**
```javascript
// âŒ JavaScript - No type safety
const userSchema = new mongoose.Schema({ ... });
module.exports = mongoose.model("User", userSchema);

// âœ… TypeScript - Type safety vá»›i interface
export interface IUser extends Document { ... }
export default mongoose.model<IUser>('User', userSchema);
```

### 3. Controller vá»›i Typed Request/Response
**ğŸ“ File:** `src/controllers/user.controller.ts`

```typescript
import * as userService from '../services/user.service';
import Role from '../models/role.model';
import Position from '../models/position.model';
import { Request, Response } from 'express'; // â­ Import types

// â­ Typed function parameters
export const getUsers = async (req: Request, res: Response) => {
    try {
        const users = await userService.getAllUser();
        res.render('users/list', { users });
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i khi láº¥y danh sÃ¡ch ngÆ°á»i dÃ¹ng');
    }
};

export const createUser = async (req: Request, res: Response) => {
    try {
        const data = { ...req.body };
        
        // â­ Type assertion cho multer file
        if ((req as any).file) {
            const uploadUrl = process.env.UPLOAD_URL || '/uploads';
            data.image = `${uploadUrl}/${(req as any).file.filename}`;
        }
        
        await userService.createNewUser(data);
        res.redirect('/users');
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i khi táº¡o ngÆ°á»i dÃ¹ng');
    }
};

export const updateUser = async (req: Request, res: Response) => {
    try {
        // â­ Explicit type annotation
        const data: any = { id: req.params.id, ...req.body };
        
        if ((req as any).file) {
            const uploadUrl = process.env.UPLOAD_URL || '/uploads';
            data.image = `${uploadUrl}/${(req as any).file.filename}`;
        }
        
        await userService.updateUser(data);
        res.redirect('/users');
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i khi cáº­p nháº­t ngÆ°á»i dÃ¹ng');
    }
};
```

**Giáº£i thÃ­ch Type Assertions:**
```typescript
// (req as any).file - Type assertion vÃ¬ Express Request khÃ´ng cÃ³ type cho multer
// Alternative: Táº¡o custom interface
interface MulterRequest extends Request {
    file?: Express.Multer.File;
}

export const createUser = async (req: MulterRequest, res: Response) => {
    if (req.file) {
        data.image = `/uploads/${req.file.filename}`;
    }
}
```

### 4. Service vá»›i Return Types
**ğŸ“ File:** `src/services/user.service.ts`

```typescript
import User, { IUser } from '../models/user.model';
import bcrypt from 'bcryptjs';

// â­ Function vá»›i explicit return type
const hashPassword = async (password: string): Promise<string> => {
    const salt = await bcrypt.genSalt(10);
    return await bcrypt.hash(password, salt);
};

// â­ Return type: Promise<IUser>
export const createNewUser = async (data: any): Promise<IUser> => {
    const hashedPassword = await hashPassword(data.password);
    return await User.create({ ...data, password: hashedPassword });
};

// â­ Return type: Promise<IUser[]>
export const getAllUser = async (): Promise<IUser[]> => {
    return await User.find({}).lean();
};

// â­ Return type: Promise<IUser | null>
export const getUserInfoById = async (id: string): Promise<IUser | null> => {
    return await User.findById(id).lean();
};

// â­ Return type: Promise<IUser | null>
export const updateUser = async (data: any): Promise<IUser | null> => {
    if (data.password) {
        data.password = await hashPassword(data.password);
    }
    return await User.findByIdAndUpdate(data.id, data, { new: true });
};

// â­ Return type: Promise<IUser | null>
export const deleteUserById = async (id: string): Promise<IUser | null> => {
    return await User.findByIdAndDelete(id);
};
```

**Type Annotations Breakdown:**
```typescript
// Parameter types        Return type
// â†“                      â†“
async (data: any): Promise<IUser> => { ... }
//     â†‘              â†‘
//     Input          Output wrapped in Promise
```

### 5. Database Config vá»›i Types
**ğŸ“ File:** `src/config/db.ts`

```typescript
import mongoose from 'mongoose';

const connectDB = async (): Promise<void> => {
    try {
        await mongoose.connect(process.env.MONGO_URI as string);
        console.log('âœ… MongoDB connected successfully');
    } catch (error) {
        console.error('âŒ MongoDB connection error:', error);
        process.exit(1);
    }
};

export default connectDB;
```

**Type assertion `as string`:**
```typescript
// process.env.MONGO_URI cÃ³ type: string | undefined
// as string: Assert ráº±ng nÃ³ lÃ  string (vÃ¬ Ä‘Ã£ check trong .env)
```

### 6. Build Scripts
**ğŸ“ File:** `package.json`

```json
{
  "scripts": {
    "build": "tsc",                    // Compile TypeScript to JavaScript
    "dev": "ts-node-dev --respawn --transpile-only src/server.ts",  
    "start": "node dist/server.js",    // Run compiled JS
    "seed": "ts-node src/seed/seedRolesPositions.ts"
  }
}
```

**Script explanations:**
- `tsc`: TypeScript compiler, reads `tsconfig.json` vÃ  compile `src/` â†’ `dist/`
- `ts-node-dev`: Run TypeScript directly, auto-reload khi code thay Ä‘á»•i
- `--transpile-only`: Skip type checking (faster development)
- `--respawn`: Auto-restart khi crash

## ğŸ” CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng

### 1. TypeScript Compilation Process
```
Source Code (.ts files)
    â†“
TypeScript Compiler (tsc)
    â†“
Type Checking (validate types)
    â†“
Transpilation (TS â†’ JS)
    â†“
JavaScript Output (dist/ folder)
    â†“
Node.js Execution
```

**VÃ­ dá»¥ compilation:**
```bash
# Development (no build needed)
npm run dev
# â†’ ts-node-dev directly executes .ts files

# Production
npm run build    # src/server.ts â†’ dist/server.js
npm start        # node dist/server.js
```

### 2. Type Safety Benefits
**JavaScript (lab02) vs TypeScript (lab03):**

```javascript
// âŒ JavaScript - Runtime error
const user = await User.findById(id);
console.log(user.firstName.toUpperCase()); // Error if user is null!

// âœ… TypeScript - Compile-time error
const user: IUser | null = await User.findById(id);
console.log(user.firstName.toUpperCase()); 
// TS Error: Object is possibly 'null'

// âœ… Fix with null check
if (user) {
    console.log(user.firstName.toUpperCase());
}
```

### 3. Interface vs Type
```typescript
// Interface (preferred for objects)
interface IUser {
    email: string;
    firstName: string;
}

// Type alias (for unions, primitives)
type UserRole = 'admin' | 'doctor' | 'patient';
type ID = string | number;

// Interface inheritance
interface IDoctor extends IUser {
    specialization: string;
}
```

### 4. Generic Types with Mongoose
```typescript
// Without generic - returns any
const user = await User.findById(id);
user.firstName // TypeScript doesn't know this exists

// With generic - returns IUser
const user = await User.findById<IUser>(id);
user.firstName // TypeScript knows firstName: string exists
```

## ğŸ’¡ VÃ­ dá»¥ cá»¥ thá»ƒ

### VÃ­ dá»¥ 1: Migration tá»« JS sang TS
**Before (JavaScript):**
```javascript
// user.controller.js
const userService = require('../services/user.service');

exports.getUsers = async (req, res) => {
    const users = await userService.getAllUser();
    res.render('users/list', { users });
};
```

**After (TypeScript):**
```typescript
// user.controller.ts
import * as userService from '../services/user.service';
import { Request, Response } from 'express';

export const getUsers = async (req: Request, res: Response): Promise<void> => {
    const users: IUser[] = await userService.getAllUser();
    res.render('users/list', { users });
};
```

**Lá»£i Ã­ch:**
- âœ… IDE autocomplete cho `req`, `res`
- âœ… Type checking: `users` pháº£i lÃ  `IUser[]`
- âœ… Compile-time error náº¿u `getAllUser()` return sai type

### VÃ­ dá»¥ 2: Custom Type Guards
```typescript
// Type guard function
function isValidUser(data: any): data is IUser {
    return (
        typeof data.email === 'string' &&
        typeof data.password === 'string' &&
        typeof data.firstName === 'string'
    );
}

// Usage
export const createUser = async (req: Request, res: Response) => {
    if (!isValidUser(req.body)) {
        return res.status(400).send('Invalid user data');
    }
    
    // Now req.body is typed as IUser
    await userService.createNewUser(req.body);
};
```

### VÃ­ dá»¥ 3: Environment Variables vá»›i Types
```typescript
// env.d.ts - Type definitions for process.env
declare global {
    namespace NodeJS {
        interface ProcessEnv {
            PORT: string;
            MONGO_URI: string;
            UPLOAD_DIR: string;
            UPLOAD_URL: string;
        }
    }
}

export {};

// Now process.env has types
const port: string = process.env.PORT; // TypeScript knows this is string
```

### VÃ­ dá»¥ 4: Async/Await vá»›i Return Types
```typescript
// Service function with explicit types
export const getUserById = async (
    id: string
): Promise<IUser | null> => {
    try {
        const user = await User.findById(id).lean<IUser>();
        return user;
    } catch (error) {
        console.error('Error fetching user:', error);
        return null;
    }
};

// Controller using the service
export const showUser = async (req: Request, res: Response): Promise<void> => {
    const user = await getUserById(req.params.id);
    
    if (!user) {
        res.status(404).send('User not found');
        return; // TypeScript knows this is valid Promise<void>
    }
    
    res.render('users/show', { user });
};
```

## ğŸ“Š So sÃ¡nh JavaScript vs TypeScript

| Äáº·c Ä‘iá»ƒm | JavaScript (lab02) | TypeScript (lab03) |
|----------|-------------------|-------------------|
| File extension | `.js` | `.ts` |
| Type checking | Runtime | Compile-time |
| IDE support | Basic | Advanced (autocomplete, refactoring) |
| Error detection | Runtime errors | Compile-time errors |
| Build step | None | Required (`tsc`) |
| Development | Direct execution | Need transpilation or ts-node |
| Refactoring | Manual, error-prone | Safe with type checking |
| Documentation | Comments only | Types as documentation |

## ğŸ¯ Káº¿t quáº£ Ä‘áº¡t Ä‘Æ°á»£c

| TiÃªu chÃ­ | Tráº¡ng thÃ¡i | Ghi chÃº |
|----------|-----------|---------|
| TypeScript setup | âœ… HoÃ n thÃ nh | tsconfig.json configured |
| Type definitions | âœ… HoÃ n thÃ nh | @types packages installed |
| Interface definitions | âœ… HoÃ n thÃ nh | IUser, IRole, IPosition |
| Typed controllers | âœ… HoÃ n thÃ nh | Request/Response types |
| Typed services | âœ… HoÃ n thÃ nh | Return types explicitly defined |
| Build process | âœ… HoÃ n thÃ nh | tsc compiles to dist/ |
| Development workflow | âœ… HoÃ n thÃ nh | ts-node-dev for hot reload |

## ğŸš€ Lá»‡nh cháº¡y project

```bash
# Di chuyá»ƒn vÃ o thÆ° má»¥c
cd lab03_typescript

# CÃ i Ä‘áº·t dependencies (includes @types packages)
npm install

# Development mode (no build needed)
npm run dev
# â†’ Auto-reload khi code thay Ä‘á»•i

# Build TypeScript to JavaScript
npm run build
# â†’ Output: dist/ folder

# Run production build
npm start
# â†’ node dist/server.js

# Seed database
npm run seed
```

## ğŸ“š Äiá»ƒm máº¡nh cá»§a TypeScript

1. **Type Safety**: Catch errors táº¡i compile-time thay vÃ¬ runtime
2. **Better IDE Support**: Autocomplete, refactoring, go-to-definition
3. **Self-Documenting Code**: Types serve as inline documentation
4. **Easier Refactoring**: Rename, change types vá»›i confidence
5. **Scalability**: Dá»… maintain khi project lá»›n
6. **Modern JavaScript**: CÃ³ thá»ƒ dÃ¹ng ES6+ features
7. **Gradual Adoption**: CÃ³ thá»ƒ migrate tá»«ng pháº§n tá»« JS sang TS

## ğŸ”§ TypeScript Best Practices (Ä‘Æ°á»£c Ã¡p dá»¥ng)

1. âœ… **Strict mode enabled**: `"strict": true` trong tsconfig.json
2. âœ… **Explicit return types**: LuÃ´n khai bÃ¡o return type cho functions
3. âœ… **Interface for objects**: Sá»­ dá»¥ng interfaces thay vÃ¬ `any`
4. âœ… **Avoid `any`**: Chá»‰ dÃ¹ng khi thá»±c sá»± cáº§n (nhÆ° multer file)
5. âœ… **Null checks**: Handle `null | undefined` cases
6. âœ… **Type imports**: Import types cÃ¹ng vá»›i values

---

**NgÃ y hoÃ n thÃ nh:** ThÃ¡ng 11/2024  
**Sinh viÃªn thá»±c hiá»‡n:** Huá»³nh Thanh Duy - 22110118
