# BT02: XÃ¢y dá»±ng á»©ng dá»¥ng CRUD vá»›i Express.js vÃ  MongoDB

## ğŸ“‹ YÃªu cáº§u Ä‘á» bÃ i
- XÃ¢y dá»±ng á»©ng dá»¥ng web vá»›i Express.js framework
- Káº¿t ná»‘i vÃ  thao tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u MongoDB
- Thá»±c hiá»‡n cÃ¡c thao tÃ¡c CRUD (Create, Read, Update, Delete)
- Sá»­ dá»¥ng template engine Ä‘á»ƒ render giao diá»‡n
- Upload vÃ  quáº£n lÃ½ file áº£nh

## âœ… Nhá»¯ng gÃ¬ Ä‘Ã£ thá»±c hiá»‡n

### ğŸ“ Project: `lab02_mongo_crud`

#### Tech Stack
```json
{
  "express": "^5.1.0",           // Web framework
  "mongoose": "^8.19.3",         // MongoDB ODM
  "ejs": "^3.1.10",              // Template engine
  "multer": "^1.4.5-lts.1",      // File upload middleware
  "bcryptjs": "^3.0.3",          // Password hashing
  "express-session": "^1.18.2",  // Session management
  "express-flash": "^0.0.2",     // Flash messages
  "dotenv": "^17.2.3",           // Environment variables
  "nodemon": "^3.1.10"           // Development auto-reload
}
```

#### Cáº¥u trÃºc dá»± Ã¡n
```
lab02_mongo_crud/
â”œâ”€â”€ package.json              
â”œâ”€â”€ .env                      # Environment variables
â”œâ”€â”€ public/
â”‚   â””â”€â”€ uploads/             # Uploaded images storage
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server.js            # Entry point
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ db.js            # MongoDB connection
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.model.js    # User schema
â”‚   â”‚   â”œâ”€â”€ role.model.js    # Role schema
â”‚   â”‚   â””â”€â”€ position.model.js # Position schema
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ home.controller.js
â”‚   â”‚   â””â”€â”€ user.controller.js # CRUD logic
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ user.service.js   # Business logic
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ user.routes.js    # Route definitions
â”‚   â”œâ”€â”€ views/               # EJS templates
â”‚   â”‚   â”œâ”€â”€ index.ejs        # Home page
â”‚   â”‚   â”œâ”€â”€ partials/        # Reusable components
â”‚   â”‚   â””â”€â”€ users/
â”‚   â”‚       â”œâ”€â”€ list.ejs     # Display all users
â”‚   â”‚       â”œâ”€â”€ create.ejs   # Add user form
â”‚   â”‚       â””â”€â”€ update.ejs   # Edit user form
â”‚   â””â”€â”€ seed/
â”‚       â””â”€â”€ seedRolesPositions.js # Database seeder
```

## ğŸ”§ Chi tiáº¿t Implementation

### 1. Database Connection (MongoDB)
**ğŸ“ File:** `src/config/db.js`

```javascript
const mongoose = require("mongoose");

const connectDB = async () => {
    try {
        await mongoose.connect(process.env.MONGO_URI);
        console.log("âœ… MongoDB connected successfully");
    } catch (error) {
        console.error("âŒ MongoDB connection error:", error);
        process.exit(1);
    }
};

module.exports = connectDB;
```

**Environment Variables (.env):**
```env
PORT=3000
MONGO_URI=mongodb://localhost:27017/lab02_crud
UPLOAD_DIR=public/uploads
UPLOAD_URL=/uploads
```

### 2. Database Models (Mongoose Schemas)

#### User Model
**ğŸ“ File:** `src/models/user.model.js`

```javascript
const mongoose = require("mongoose");

const userSchema = new mongoose.Schema(
    {
        email: { type: String, required: true, unique: true },
        password: { type: String, required: true },
        firstName: { type: String, required: true },
        lastName: { type: String, required: true },
        address: { type: String },
        phoneNumber: { type: String },
        gender: { type: Boolean, default: true }, // true = male, false = female
        image: { type: String }, // Image URL
        roleId: { type: String, default: "R1" },
        positionId: { type: String, default: "P0" },
    },
    {
        timestamps: true, // Auto createdAt, updatedAt
    }
);

module.exports = mongoose.model("User", userSchema);
```

**Giáº£i thÃ­ch:**
- `timestamps: true`: Tá»± Ä‘á»™ng táº¡o `createdAt` vÃ  `updatedAt`
- `unique: true` cho email: Äáº£m báº£o khÃ´ng trÃ¹ng email
- `default` values: GiÃ¡ trá»‹ máº·c Ä‘á»‹nh khi táº¡o user má»›i
- `type: String`: Äá»‹nh nghÄ©a kiá»ƒu dá»¯ liá»‡u

#### Role vÃ  Position Models
**ğŸ“ Files:** `src/models/role.model.js`, `src/models/position.model.js`

```javascript
// role.model.js
const mongoose = require("mongoose");

const roleSchema = new mongoose.Schema({
    keyMap: { type: String, required: true, unique: true }, // R1, R2, R3
    type: { type: String, required: true },                  // Admin, Doctor, Patient
});

module.exports = mongoose.model("Role", roleSchema);

// position.model.js
const positionSchema = new mongoose.Schema({
    keyMap: { type: String, required: true, unique: true }, // P0, P1, P2
    type: { type: String, required: true },                  // None, Doctor, Nurse
});

module.exports = mongoose.model("Position", positionSchema);
```

### 3. MVC Pattern Implementation

#### Controller Layer - CRUD Operations
**ğŸ“ File:** `src/controllers/user.controller.js`

```javascript
const userService = require("../services/user.service");
const Role = require("../models/role.model");
const Position = require("../models/position.model");

// READ - Láº¥y danh sÃ¡ch users
exports.getUsers = async (req, res) => {
    try {
        const users = await userService.getAllUser();
        res.render("users/list", { users });
    } catch (err) {
        console.error(err);
        res.status(500).send("Lá»—i khi láº¥y danh sÃ¡ch ngÆ°á»i dÃ¹ng");
    }
};

// CREATE - Hiá»ƒn thá»‹ form thÃªm
exports.addForm = async (req, res) => {
    try {
        const roles = await Role.find({}).lean();
        const positions = await Position.find({}).lean();
        res.render("users/create", { roles, positions });
    } catch (err) {
        console.error(err);
        res.status(500).send('Lá»—i khi táº£i form');
    }
};

// CREATE - ThÃªm user má»›i
exports.createUser = async (req, res) => {
    try {
        const data = { ...req.body };
        // Xá»­ lÃ½ upload áº£nh
        if (req.file) {
            const uploadUrl = process.env.UPLOAD_URL || '/uploads';
            data.image = `${uploadUrl}/${req.file.filename}`;
        }
        await userService.createNewUser(data);
        res.redirect("/users");
    } catch (err) {
        console.error(err);
        res.status(500).send("Lá»—i khi táº¡o ngÆ°á»i dÃ¹ng");
    }
};

// UPDATE - Hiá»ƒn thá»‹ form sá»­a
exports.editForm = async (req, res) => {
    try {
        const user = await userService.getUserInfoById(req.params.id);
        if (!user) return res.status(404).send("NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i");
        
        const roles = await Role.find({}).lean();
        const positions = await Position.find({}).lean();
        res.render("users/update", { user, roles, positions });
    } catch (err) {
        console.error(err);
        res.status(500).send("Lá»—i khi láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng");
    }
};

// UPDATE - Cáº­p nháº­t user
exports.updateUser = async (req, res) => {
    try {
        const data = { id: req.params.id, ...req.body };
        if (req.file) {
            const uploadUrl = process.env.UPLOAD_URL || '/uploads';
            data.image = `${uploadUrl}/${req.file.filename}`;
        }
        await userService.updateUser(data);
        res.redirect("/users");
    } catch (err) {
        console.error(err);
        res.status(500).send("Lá»—i khi cáº­p nháº­t ngÆ°á»i dÃ¹ng");
    }
};

// DELETE - XÃ³a user
exports.deleteUser = async (req, res) => {
    try {
        await userService.deleteUserById(req.params.id);
        res.redirect("/users");
    } catch (err) {
        console.error(err);
        res.status(500).send("Lá»—i khi xÃ³a ngÆ°á»i dÃ¹ng");
    }
};
```

#### Service Layer - Business Logic
**ğŸ“ File:** `src/services/user.service.js`

```javascript
const User = require("../models/user.model");
const bcrypt = require("bcryptjs");

// Hash password
const hashPassword = async (password) => {
    const salt = await bcrypt.genSalt(10);
    return await bcrypt.hash(password, salt);
};

// CREATE
exports.createNewUser = async (data) => {
    const hashedPassword = await hashPassword(data.password);
    return await User.create({ ...data, password: hashedPassword });
};

// READ
exports.getAllUser = async () => {
    return await User.find({}).lean();
};

exports.getUserInfoById = async (id) => {
    return await User.findById(id).lean();
};

// UPDATE
exports.updateUser = async (data) => {
    if (data.password) {
        data.password = await hashPassword(data.password);
    }
    return await User.findByIdAndUpdate(data.id, data, { new: true });
};

// DELETE
exports.deleteUserById = async (id) => {
    return await User.findByIdAndDelete(id);
};
```

### 4. Routing System
**ğŸ“ File:** `src/routes/user.routes.js`

```javascript
const express = require("express");
const router = express.Router();
const multer = require("multer");
const path = require("path");
const userController = require("../controllers/user.controller");

// Multer configuration cho upload file
const envUploadDir = process.env.UPLOAD_DIR || 'public/uploads';
const resolvedUploadDir = path.isAbsolute(envUploadDir) 
    ? envUploadDir 
    : path.join(process.cwd(), envUploadDir);

const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, resolvedUploadDir);
    },
    filename: function (req, file, cb) {
        const unique = Date.now() + '-' + Math.round(Math.random() * 1e9);
        const ext = path.extname(file.originalname);
        cb(null, `${unique}${ext}`);
    },
});

const upload = multer({ storage });

// CRUD Routes
router.get("/", userController.getUsers);                      // READ all
router.get("/add", userController.addForm);                    // CREATE form
router.post("/add", upload.single('image'), userController.createUser);  // CREATE action
router.get("/edit/:id", userController.editForm);              // UPDATE form
router.post("/update/:id", upload.single('image'), userController.updateUser); // UPDATE action
router.get("/delete/:id", userController.deleteUser);          // DELETE

module.exports = router;
```

### 5. Server Setup
**ğŸ“ File:** `src/server.js`

```javascript
require("dotenv").config();
const express = require("express");
const path = require('path');
const bodyParser = require("body-parser");
const connectDB = require("./config/db");
const userRoutes = require("./routes/user.routes");

const app = express();

// Middleware
app.use(bodyParser.urlencoded({ extended: false }));
app.set("view engine", "ejs");
app.set("views", "./src/views");
app.use(express.static("public"));

// Serve uploads vá»›i configurable URL
const uploadUrl = process.env.UPLOAD_URL || '/uploads';
let uploadDir = process.env.UPLOAD_DIR || 'public/uploads';
if (!path.isAbsolute(uploadDir)) {
    uploadDir = path.join(process.cwd(), uploadDir);
}
app.use(uploadUrl, express.static(uploadDir));

// Routes
app.use("/users", userRoutes);
app.get("/", (req, res) => res.render("index"));

// Connect DB vÃ  start server
connectDB();
app.listen(process.env.PORT, () =>
    console.log(`Server running on http://localhost:${process.env.PORT}`)
);
```

## ğŸ” CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng

### 1. Request Flow (MVC Pattern)
```
Browser Request
    â†“
Express Router (/users/add)
    â†“
Controller (userController.addForm)
    â†“
Service Layer (getAllUser, getRole, getPosition)
    â†“
Model (Mongoose Query)
    â†“
MongoDB Database
    â†“
Response â†’ EJS Template â†’ HTML â†’ Browser
```

### 2. File Upload Flow (Multer)
```
1. User uploads image via form
   <form method="POST" enctype="multipart/form-data">
     <input type="file" name="image">
   </form>

2. Multer middleware processes file
   upload.single('image')
   
3. File saved to public/uploads/
   Filename: timestamp-randomnumber.extension
   Example: 1703090400000-123456789.jpg
   
4. File path stored in database
   data.image = "/uploads/1703090400000-123456789.jpg"
   
5. Image accessed via static middleware
   <img src="/uploads/1703090400000-123456789.jpg">
```

### 3. Password Security
```javascript
// When creating user:
1. User submits password: "123456"
2. bcrypt generates salt: bcrypt.genSalt(10)
3. Hash password: bcrypt.hash("123456", salt)
4. Store hashed: "$2a$10$xyz..." in database

// When logging in:
1. User submits password: "123456"
2. Fetch hashed password from DB
3. Compare: bcrypt.compare("123456", hashedPassword)
4. Return true/false
```

### 4. Database Seeding
**ğŸ“ File:** `src/seed/seedRolesPositions.js`

```javascript
const mongoose = require("mongoose");
const Role = require("../models/role.model");
const Position = require("../models/position.model");

const seedRolesPositions = async () => {
    await mongoose.connect(process.env.MONGO_URI);
    
    // Seed Roles
    await Role.insertMany([
        { keyMap: "R1", type: "Admin" },
        { keyMap: "R2", type: "Doctor" },
        { keyMap: "R3", type: "Patient" },
    ]);
    
    // Seed Positions
    await Position.insertMany([
        { keyMap: "P0", type: "None" },
        { keyMap: "P1", type: "Doctor" },
        { keyMap: "P2", type: "Nurse" },
    ]);
    
    console.log("âœ… Seeding completed");
    process.exit(0);
};

seedRolesPositions();
```

**Cháº¡y seeder:**
```bash
npm run seed
```

## ğŸ’¡ VÃ­ dá»¥ cá»¥ thá»ƒ

### VÃ­ dá»¥ 1: Create User Flow
```javascript
// 1. User truy cáº­p GET /users/add
// Controller renders form vá»›i roles vÃ  positions

// 2. User Ä‘iá»n form vÃ  submit POST /users/add
Form data:
{
  email: "john@example.com",
  password: "123456",
  firstName: "John",
  lastName: "Doe",
  gender: "true",
  roleId: "R2",
  positionId: "P1",
  image: [File]
}

// 3. Multer xá»­ lÃ½ file upload â†’ req.file
{
  filename: "1703090400000-123456789.jpg",
  path: "/public/uploads/1703090400000-123456789.jpg"
}

// 4. Controller gá»i service
await userService.createNewUser({
  ...req.body,
  image: "/uploads/1703090400000-123456789.jpg"
});

// 5. Service hash password vÃ  save vÃ o MongoDB
const hashedPassword = await bcrypt.hash("123456", salt);
await User.create({ ...data, password: hashedPassword });

// 6. Redirect vá» /users (danh sÃ¡ch users)
```

### VÃ­ dá»¥ 2: Read Users vá»›i Mongoose
```javascript
// Controller
exports.getUsers = async (req, res) => {
    const users = await userService.getAllUser();
    res.render("users/list", { users });
};

// Service
exports.getAllUser = async () => {
    return await User.find({}).lean(); // .lean() returns plain JS objects
};

// EJS Template (users/list.ejs)
<% users.forEach(user => { %>
    <tr>
        <td><%= user.email %></td>
        <td><%= user.firstName %> <%= user.lastName %></td>
        <td><img src="<%= user.image %>" width="50"></td>
        <td>
            <a href="/users/edit/<%= user._id %>">Edit</a>
            <a href="/users/delete/<%= user._id %>">Delete</a>
        </td>
    </tr>
<% }); %>
```

### VÃ­ dá»¥ 3: Update User
```javascript
// 1. GET /users/edit/:id - Hiá»ƒn thá»‹ form vá»›i data hiá»‡n táº¡i
exports.editForm = async (req, res) => {
    const user = await User.findById(req.params.id).lean();
    const roles = await Role.find({}).lean();
    const positions = await Position.find({}).lean();
    res.render("users/update", { user, roles, positions });
};

// 2. POST /users/update/:id - Cáº­p nháº­t data
exports.updateUser = async (req, res) => {
    const data = { id: req.params.id, ...req.body };
    if (req.file) {
        data.image = `/uploads/${req.file.filename}`;
    }
    await User.findByIdAndUpdate(data.id, data, { new: true });
    res.redirect("/users");
};
```

## ğŸ“Š Mongoose Query Methods

| Method | MÃ´ táº£ | VÃ­ dá»¥ |
|--------|-------|-------|
| `find()` | TÃ¬m táº¥t cáº£ documents | `User.find({})` |
| `findById()` | TÃ¬m theo _id | `User.findById(id)` |
| `findOne()` | TÃ¬m 1 document | `User.findOne({ email })` |
| `create()` | Táº¡o má»›i | `User.create(data)` |
| `findByIdAndUpdate()` | TÃ¬m vÃ  cáº­p nháº­t | `User.findByIdAndUpdate(id, data)` |
| `findByIdAndDelete()` | TÃ¬m vÃ  xÃ³a | `User.findByIdAndDelete(id)` |
| `lean()` | Tráº£ vá» plain object | `User.find({}).lean()` |

## ğŸ¯ Káº¿t quáº£ Ä‘áº¡t Ä‘Æ°á»£c

| TiÃªu chÃ­ | Tráº¡ng thÃ¡i | Ghi chÃº |
|----------|-----------|---------|
| Express.js setup | âœ… HoÃ n thÃ nh | Server running on port 3000 |
| MongoDB connection | âœ… HoÃ n thÃ nh | Mongoose 8.19.3 |
| CRUD operations | âœ… HoÃ n thÃ nh | Create, Read, Update, Delete |
| File upload | âœ… HoÃ n thÃ nh | Multer with configurable paths |
| EJS templating | âœ… HoÃ n thÃ nh | Views with partials |
| Password hashing | âœ… HoÃ n thÃ nh | bcryptjs vá»›i salt rounds = 10 |
| Database seeding | âœ… HoÃ n thÃ nh | Roles vÃ  Positions |

## ğŸš€ Lá»‡nh cháº¡y project

```bash
# Di chuyá»ƒn vÃ o thÆ° má»¥c
cd lab02_mongo_crud

# CÃ i Ä‘áº·t dependencies
npm install

# Seed database (cháº¡y 1 láº§n Ä‘áº§u)
npm run seed

# Cháº¡y development server vá»›i auto-reload
npm run dev

# Access application
# http://localhost:3000 - Home page
# http://localhost:3000/users - User management
```

## ğŸ“š Äiá»ƒm máº¡nh cá»§a implementation

1. **MVC Architecture**: TÃ¡ch biá»‡t rÃµ rÃ ng Controller-Service-Model
2. **Mongoose ODM**: Type safety, schema validation, middleware hooks
3. **Multer Configuration**: Flexible upload paths via environment variables
4. **Password Security**: bcryptjs hashing vá»›i salt
5. **EJS Templating**: Server-side rendering vá»›i partials Ä‘á»ƒ reuse code
6. **Error Handling**: Try-catch blocks trong má»i async operations
7. **Nodemon**: Auto-reload khi code thay Ä‘á»•i (development productivity)

---

**NgÃ y hoÃ n thÃ nh:** ThÃ¡ng 11/2024  
**Sinh viÃªn thá»±c hiá»‡n:** Huá»³nh Thanh Duy - 22110118
