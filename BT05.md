# BT05: X√¢y d·ª±ng H·ªá th·ªëng Qu·∫£n l√Ω T√≤a nh√† Full-Stack

## üìã Y√™u c·∫ßu ƒë·ªÅ b√†i
- X√¢y d·ª±ng h·ªá th·ªëng qu·∫£n l√Ω t√≤a nh√† v·ªõi nhi·ªÅu vai tr√≤ ng∆∞·ªùi d√πng
- Implement c·∫•u tr√∫c d·ªØ li·ªáu ph√¢n c·∫•p (Block ‚Üí Building ‚Üí Floor ‚Üí Apartment)
- Role-Based Access Control (RBAC) v·ªõi nhi·ªÅu levels
- Marketplace cho thu√™/b√°n cƒÉn h·ªô
- Interactive 3D building visualization
- Security layers: Rate limiting, validation, authentication, authorization

## ‚úÖ Nh·ªØng g√¨ ƒë√£ th·ª±c hi·ªán

### üìç Project: `lab05_ManageBuilding`

#### Tech Stack

**Backend:**
```json
{
  "express": "^4.18.2",              // Web framework
  "sequelize": "^6.34.0",            // MySQL ORM
  "mysql2": "^3.6.3",                // MySQL driver
  "jsonwebtoken": "^9.0.2",          // JWT authentication
  "bcryptjs": "^2.4.3",              // Password hashing
  "helmet": "^7.1.0",                // Security headers (CSP)
  "cors": "^2.8.5",                  // CORS middleware
  "express-rate-limit": "^7.1.5",    // Rate limiting (Layer 1)
  "express-validator": "^7.0.1",     // Input validation (Layer 3)
  "fuse.js": "^7.1.0",               // Fuzzy search
  "apollo-server-express": "^3.13.0", // GraphQL server
  "graphql": "^16.12.0",             // GraphQL implementation
  "multer": "^1.4.5-lts.1",          // File uploads
  "nodemailer": "^6.9.7"             // Email service
}
```

**Frontend:**
```json
{
  "react": "^18.2.0",                // UI library (React 18)
  "react-router-dom": "^6.18.0",     // Client-side routing
  "vite": "^4.5.0",                  // Build tool
  "axios": "^1.6.0",                 // HTTP client
  "tailwindcss": "^3.4.18",          // CSS framework
  "react-hot-toast": "^2.6.0",       // Toast notifications
  "@heroicons/react": "^2.0.18",     // Icon library
  "react-hook-form": "^7.47.0"       // Form handling
}
```

#### C·∫•u tr√∫c d·ª± √°n
```
lab05_ManageBuilding/
‚îú‚îÄ‚îÄ README.md                        # Project overview
‚îú‚îÄ‚îÄ DATABASE_RELATIONSHIPS.md        # Database schema documentation
‚îú‚îÄ‚îÄ TEST_LEASE_WORKFLOW.md          # Lease request workflow
‚îú‚îÄ‚îÄ BUG_FIXES_DEC_9.md              # Bug fix documentation
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.js                # Entry point v·ªõi security layers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.js          # Sequelize configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/                  # Sequelize models
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js             # Model associations (critical)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js              # User v·ªõi role/position
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Block.js             # Khu (Campus)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Building.js          # T√≤a nh√† (S.01-S.10)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Floor.js             # T·∫ßng (1-6)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Apartment.js         # CƒÉn h·ªô
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HouseholdMember.js   # Th√†nh vi√™n h·ªô gia ƒë√¨nh
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LeaseRequest.js      # Y√™u c·∫ßu thu√™/mua
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cart.js              # Shopping cart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CartItem.js          # Cart items
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/             # Business logic
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.js   # Authentication
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ block.controller.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ building.controller.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ floor.controller.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apartment.controller.js # CRUD + fuzzy search
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lease.controller.js  # Lease workflow
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart.controller.js   # Cart management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/              # 4-layer security
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rateLimiter.js       # Layer 1: Rate limiting
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js              # Layer 2: JWT auth + RBAC
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.js        # Layer 3: Input validation
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.js      # Error handling
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ graphql/                 # GraphQL for cart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart.schema.js       # Schema definitions
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart.resolvers.js    # Query/Mutation resolvers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/                  # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/                # Business logic services
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seeders/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.js             # Seed 10 buildings + users
‚îÇ   ‚îî‚îÄ‚îÄ uploads/
‚îÇ       ‚îî‚îÄ‚îÄ avatars/
‚îî‚îÄ‚îÄ frontend/
    ‚îú‚îÄ‚îÄ package.json
    ‚îú‚îÄ‚îÄ vite.config.js
    ‚îú‚îÄ‚îÄ tailwind.config.js
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îú‚îÄ‚îÄ main.jsx
    ‚îÇ   ‚îú‚îÄ‚îÄ App.jsx                  # Root v·ªõi routing
    ‚îÇ   ‚îú‚îÄ‚îÄ contexts/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.jsx      # Authentication state
    ‚îÇ   ‚îú‚îÄ‚îÄ services/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.js               # Axios v·ªõi interceptors
    ‚îÇ   ‚îú‚îÄ‚îÄ pages/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Login.jsx
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Register.jsx
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.jsx        # Role-based dashboard
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ buildings/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ InteractiveBuildingMap.jsx # 3D visualization
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ marketplace/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Marketplace.jsx  # Browse apartments
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ApartmentDetailPage.jsx
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/
    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Cart.jsx         # Shopping cart
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ requests/
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ MyRequests.jsx   # Track lease requests
    ‚îÇ   ‚îú‚îÄ‚îÄ components/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ map/                 # 3D building components
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/                # Cart components
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PrivateRoute.jsx     # Route protection
    ‚îÇ   ‚îî‚îÄ‚îÄ styles/
    ‚îÇ       ‚îî‚îÄ‚îÄ InteractiveBuildingMap.css # 3D CSS transforms
    ‚îî‚îÄ‚îÄ public/
```

## üîß Chi ti·∫øt Implementation

### 1. Database Schema - Hierarchical Structure

#### C·∫•u tr√∫c ph√¢n c·∫•p
```
Block (Khu/Campus)
    ‚Üì hasMany
Building (T√≤a nh√†) - S.01, S.02, ..., S.10
    ‚Üì hasMany
Floor (T·∫ßng) - Floor 1-6
    ‚Üì hasMany
Apartment (CƒÉn h·ªô) - Format: FFAA (0101-0606)
    ‚Üì hasMany
HouseholdMember (Th√†nh vi√™n gia ƒë√¨nh)
```

#### Model Associations
**üìç File:** `backend/src/models/index.js`

```javascript
// Block ‚Üí Building (1:N)
Block.hasMany(Building, { foreignKey: 'blockId', as: 'buildings' });
Building.belongsTo(Block, { foreignKey: 'blockId', as: 'block' });

// Building ‚Üí Floor (1:N)
Building.hasMany(Floor, { foreignKey: 'buildingId', as: 'floors' });
Floor.belongsTo(Building, { foreignKey: 'buildingId', as: 'building' });

// Floor ‚Üí Apartment (1:N)
Floor.hasMany(Apartment, { foreignKey: 'floorId', as: 'apartments' });
Apartment.belongsTo(Floor, { foreignKey: 'floorId', as: 'floor' });

// Apartment ‚Üí HouseholdMember (1:N)
Apartment.hasMany(HouseholdMember, { foreignKey: 'apartmentId', as: 'members' });
HouseholdMember.belongsTo(Apartment, { foreignKey: 'apartmentId', as: 'apartment' });

// User ‚Üí HouseholdMember (1:1)
User.hasOne(HouseholdMember, { foreignKey: 'userId', as: 'householdMember' });
HouseholdMember.belongsTo(User, { foreignKey: 'userId', as: 'user' });

// User ‚Üí Block (Manager) (1:N)
User.hasMany(Block, { foreignKey: 'managerId', as: 'managedBlocks' });
Block.belongsTo(User, { foreignKey: 'managerId', as: 'manager' });

// User ‚Üí Building (Manager) (1:N)
User.hasMany(Building, { foreignKey: 'managerId', as: 'managedBuildings' });
Building.belongsTo(User, { foreignKey: 'managerId', as: 'manager' });
```

#### Apartment Model v·ªõi Owner/Tenant
**üìç File:** `backend/src/models/Apartment.js`

```javascript
const Apartment = sequelize.define('Apartment', {
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    apartmentNumber: {
        type: DataTypes.STRING(20),
        allowNull: false,
        validate: {
            notEmpty: true,
            len: [1, 20]
        }
    },
    floorId: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {
            model: 'floors',
            key: 'id'
        }
    },
    ownerId: {
        type: DataTypes.INTEGER,
        allowNull: true,
        references: {
            model: 'Users',
            key: 'id'
        },
        comment: 'Owner of the apartment'
    },
    tenantId: {
        type: DataTypes.INTEGER,
        allowNull: true,
        references: {
            model: 'Users',
            key: 'id'
        },
        comment: 'Current tenant/renter'
    },
    type: {
        type: DataTypes.ENUM('studio', '1bhk', '2bhk', '3bhk', '4bhk', 'penthouse', 'duplex'),
        allowNull: false,
        defaultValue: '2bhk'
    },
    area: {
        type: DataTypes.DECIMAL(8, 2),
        allowNull: false,
        comment: 'Area in square feet'
    },
    bedrooms: {
        type: DataTypes.INTEGER,
        allowNull: false,
        validate: { min: 0, max: 10 }
    },
    bathrooms: {
        type: DataTypes.INTEGER,
        allowNull: false,
        validate: { min: 1, max: 10 }
    },
    balconies: {
        type: DataTypes.INTEGER,
        defaultValue: 0,
        validate: { min: 0, max: 5 }
    },
    status: {
        type: DataTypes.ENUM('for_rent', 'for_sale', 'occupied', 'under_renovation'),
        allowNull: false,
        defaultValue: 'for_rent'
    },
    monthlyRent: {
        type: DataTypes.DECIMAL(10, 2),
        allowNull: true,
        comment: 'Monthly rent amount'
    },
    salePrice: {
        type: DataTypes.DECIMAL(12, 2),
        allowNull: true,
        comment: 'Sale price'
    },
    isListedForRent: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    },
    isListedForSale: {
        type: DataTypes.BOOLEAN,
        defaultValue: false
    },
    parkingSlots: {
        type: DataTypes.INTEGER,
        defaultValue: 0
    },
    images: {
        type: DataTypes.JSON,
        defaultValue: [],
        comment: 'Array of image URLs (3-5 images per apartment)'
    },
    description: DataTypes.TEXT,
    amenities: {
        type: DataTypes.JSON,
        defaultValue: []
    },
    isActive: {
        type: DataTypes.BOOLEAN,
        defaultValue: true
    }
}, {
    tableName: 'apartments',
    timestamps: true
});
```

### 2. Role-Based Access Control (RBAC)

#### User Roles
**üìç ƒê·ªãnh nghƒ©a trong seeder:** `backend/src/seeders/index.js`

```javascript
const roles = [
    { name: 'admin', description: 'System Administrator' },
    { name: 'building_manager', description: 'Building Manager' },
    { name: 'resident', description: 'Apartment Resident/Owner' },
    { name: 'security', description: 'Security Personnel' },
    { name: 'technician', description: 'Maintenance Technician' },
    { name: 'accountant', description: 'Financial Manager' },
    { name: 'user', description: 'Basic User (Guest)' }
];
```

#### Sample Accounts
| Role | Email | Password | Access Level |
|------|-------|----------|--------------|
| Admin | admin@building.com | admin123 | Full system access |
| Building Manager | manager@building.com | manager123 | Building operations |
| Security | security@building.com | security123 | Visitor management |
| Technician | tech@building.com | tech123 | Maintenance tasks |
| Accountant | accountant@building.com | account123 | Financial management |
| Resident | 22110118@student.hcmute.edu.vn | duy123 | Personal services |

#### Authentication Middleware
**üìç File:** `backend/src/middleware/auth.js`

```javascript
// Strict authentication (returns 401 if missing/invalid token)
const authMiddleware = async (req, res, next) => {
    try {
        // Extract token from Authorization header or cookies
        let token = req.header('Authorization');
        if (token && token.startsWith('Bearer ')) {
            token = token.replace('Bearer ', '');
        } else if (req.cookies?.token) {
            token = req.cookies.token;
        }

        if (!token) {
            return res.status(401).json({
                success: false,
                message: 'Access denied. No token provided.',
                code: 'NO_TOKEN'
            });
        }

        // Verify JWT token
        let decoded;
        try {
            decoded = jwt.verify(token, process.env.JWT_SECRET);
        } catch (err) {
            return res.status(401).json({
                success: false,
                message: err.name === 'TokenExpiredError'
                    ? 'Token has expired.'
                    : 'Invalid token.',
                code: err.name === 'TokenExpiredError'
                    ? 'TOKEN_EXPIRED'
                    : 'INVALID_TOKEN'
            });
        }

        // Fetch user with role and position
        const user = await User.findByPk(decoded.id, {
            include: [
                {
                    model: Role,
                    as: 'role',
                    attributes: ['id', 'name', 'description']
                },
                {
                    model: Position,
                    as: 'position',
                    attributes: ['id', 'title', 'department', 'description']
                }
            ],
            attributes: { exclude: ['password'] }
        });

        if (!user || !user.isActive) {
            return res.status(401).json({
                success: false,
                message: 'User not found or account deactivated.'
            });
        }

        // Attach user to request
        req.user = user;
        req.userRole = user.role?.name || null;

        next();
    } catch (error) {
        console.error('Auth middleware error:', error);
        return res.status(500).json({
            success: false,
            message: 'Internal server error'
        });
    }
};

// Optional auth (allows both guest and authenticated access)
const optionalAuth = async (req, res, next) => {
    try {
        let token = req.header('Authorization');
        if (token && token.startsWith('Bearer ')) {
            token = token.replace('Bearer ', '');
        } else if (req.cookies?.token) {
            token = req.cookies.token;
        }

        if (!token) {
            // No token ‚Üí Guest user
            req.user = null;
            req.userRole = null;
            return next();
        }

        // Token present ‚Üí Validate and attach user
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        const user = await User.findByPk(decoded.id, {
            include: [
                { model: Role, as: 'role', attributes: ['id', 'name'] },
                { model: Position, as: 'position', attributes: ['id', 'title'] }
            ]
        });

        if (user && user.isActive) {
            req.user = user;
            req.userRole = user.role?.name || null;
        } else {
            req.user = null;
            req.userRole = null;
        }

        next();
    } catch (error) {
        // Invalid token ‚Üí Treat as guest
        req.user = null;
        req.userRole = null;
        next();
    }
};

// Role-based middleware
const requireRole = (roles = []) => {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({
                success: false,
                message: 'Authentication required.'
            });
        }

        const userRole = req.user.role?.name;
        if (!roles.includes(userRole)) {
            return res.status(403).json({
                success: false,
                message: `Access denied. Required roles: ${roles.join(', ')}`
            });
        }

        next();
    };
};
```

**Critical middleware patterns:**
- `authMiddleware`: Strict JWT check, 401 if missing/invalid
- `optionalAuth`: Allows guest + authenticated access (marketplace, 3D map)
- `requireRole(['admin', 'building_manager'])`: Role-based restrictions

### 3. 4-Layer Security Architecture

**üìç File:** `backend/src/server.js`

```javascript
const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const { generalLimiter } = require('./middleware/rateLimiter');

const app = express();

// =======================
// LAYER 1: Rate Limiting
// =======================
app.use(generalLimiter);

// =======================
// LAYER 2: Security Headers (Helmet + CSP)
// =======================
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-inline'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            imgSrc: ["'self'", "data:", "https:"],
            connectSrc: ["'self'", "http://localhost:5000", "http://localhost:5001"],
            fontSrc: ["'self'"],
            objectSrc: ["'none'"],
            mediaSrc: ["'self'"],
            frameSrc: ["'none'"]
        }
    },
    crossOriginEmbedderPolicy: false
}));

// =======================
// LAYER 3: Input Validation
// =======================
// Applied in routes with express-validator middleware
// Example: validateRegister middleware in auth.routes.js

// =======================
// LAYER 4: Authentication + Authorization
// =======================
// Applied in routes with authMiddleware, optionalAuth, requireRole
// Example: router.get('/apartments', authMiddleware, requireRole(['admin']))

// CORS configuration
app.use(cors({
    origin: process.env.CLIENT_URL || 'http://localhost:3000',
    credentials: true
}));

// Body parsers
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Routes
app.use('/api/auth', require('./routes/auth.routes'));
app.use('/api/blocks', require('./routes/block.routes'));
app.use('/api/buildings', require('./routes/building.routes'));
app.use('/api/floors', require('./routes/floor.routes'));
app.use('/api/apartments', require('./routes/apartment.routes'));
app.use('/api/leases', require('./routes/lease.routes'));

// GraphQL endpoint
const { ApolloServer } = require('apollo-server-express');
const typeDefs = require('./graphql/cart.schema');
const resolvers = require('./graphql/cart.resolvers');

const apolloServer = new ApolloServer({
    typeDefs,
    resolvers,
    context: ({ req }) => {
        // Extract user from JWT token
        let token = req.headers.authorization?.replace('Bearer ', '');
        if (token) {
            try {
                const decoded = jwt.verify(token, process.env.JWT_SECRET);
                return { userId: decoded.id };
            } catch (err) {
                return { userId: null };
            }
        }
        return { userId: null };
    }
});

await apolloServer.start();
apolloServer.applyMiddleware({ app, path: '/graphql' });
```

#### Layer 1: Rate Limiting
**üìç File:** `backend/src/middleware/rateLimiter.js`

```javascript
const rateLimit = require('express-rate-limit');

// General API rate limiter
const generalLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // 100 requests per 15min
    message: {
        success: false,
        message: 'Too many requests, please try again later.'
    }
});

// Login rate limiter (stricter)
const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 5, // 5 login attempts per 15min
    message: {
        success: false,
        message: 'Too many login attempts, please try again later.'
    }
});

module.exports = { generalLimiter, loginLimiter };
```

#### Layer 3: Input Validation
**üìç File:** `backend/src/middleware/validation.js`

```javascript
const { body, validationResult } = require('express-validator');

// Register validation rules
const validateRegister = [
    body('firstName').trim().notEmpty().withMessage('First name is required'),
    body('lastName').trim().notEmpty().withMessage('Last name is required'),
    body('email').isEmail().withMessage('Invalid email address'),
    body('password')
        .isLength({ min: 6 })
        .withMessage('Password must be at least 6 characters'),
    body('phone')
        .optional()
        .matches(/^[0-9]{10,15}$/)
        .withMessage('Invalid phone number'),
    (req, res, next) => {
        const errors = validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(400).json({
                success: false,
                errors: errors.array()
            });
        }
        next();
    }
];

// Apartment creation validation
const validateApartment = [
    body('apartmentNumber').trim().notEmpty(),
    body('floorId').isInt().withMessage('Valid floor ID required'),
    body('type').isIn(['studio', '1bhk', '2bhk', '3bhk', '4bhk', 'penthouse', 'duplex']),
    body('area').isFloat({ min: 0 }).withMessage('Area must be positive'),
    body('bedrooms').isInt({ min: 0, max: 10 }),
    body('bathrooms').isInt({ min: 1, max: 10 }),
    (req, res, next) => {
        const errors = validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(400).json({
                success: false,
                errors: errors.array()
            });
        }
        next();
    }
];

module.exports = {
    validateRegister,
    validateApartment
};
```

### 4. Marketplace & Lease Request Workflow

#### Lease Request Controller
**üìç File:** `backend/src/controllers/lease.controller.js`

```javascript
// Create lease request (guest or authenticated user)
const createLeaseRequest = async (req, res) => {
    try {
        const userId = req.user?.id || null;
        const userRole = req.user?.role?.name;
        const {
            apartmentId,
            type = 'rent',
            startDate,
            endDate,
            monthlyRent,
            totalPrice,
            note,
            contactName,
            contactEmail,
            contactPhone
        } = req.body;

        // Block staff roles from creating lease requests
        const staffRoles = ['admin', 'building_manager', 'security', 'technician', 'accountant'];
        if (userRole && staffRoles.includes(userRole)) {
            return res.status(403).json({
                success: false,
                message: 'Staff members cannot create lease requests.'
            });
        }

        // Block existing residents/owners from creating new lease requests
        if (userRole && ['resident', 'owner'].includes(userRole)) {
            return res.status(403).json({
                success: false,
                message: 'Residents and owners cannot create new lease requests.'
            });
        }

        // For guests (userId is null), require contact information
        if (!userId) {
            if (!contactName || !contactEmail || !contactPhone) {
                return res.status(400).json({
                    success: false,
                    message: 'Contact information required for guest requests'
                });
            }
        }

        // Fetch apartment with building info
        const apartment = await Apartment.findByPk(apartmentId, {
            include: [
                {
                    model: Floor,
                    as: 'floor',
                    include: [{ model: Building, as: 'building' }]
                }
            ]
        });

        if (!apartment || !apartment.isActive) {
            return res.status(404).json({
                success: false,
                message: 'Apartment not found'
            });
        }

        // Check availability
        if (apartment.status === 'occupied') {
            return res.status(400).json({
                success: false,
                message: 'Apartment is already occupied'
            });
        }

        // Create lease request
        const leaseRequest = await LeaseRequest.create({
            userId,
            apartmentId,
            type,
            startDate,
            endDate,
            monthlyRent: type === 'rent' ? monthlyRent : null,
            totalPrice: type === 'purchase' ? totalPrice : null,
            status: 'pending',
            note,
            contactName: !userId ? contactName : null,
            contactEmail: !userId ? contactEmail : null,
            contactPhone: !userId ? contactPhone : null
        });

        res.status(201).json({
            success: true,
            message: 'Lease request submitted successfully',
            data: leaseRequest
        });
    } catch (error) {
        console.error('Create lease request error:', error);
        res.status(500).json({
            success: false,
            message: 'Failed to create lease request'
        });
    }
};
```

**Lease Request Workflow:**
```
1. Guest/User submits lease request
   ‚Üì
2. Request stored with status: 'pending'
   ‚Üì
3. Building Manager reviews request
   ‚Üì
4. Manager approves ‚Üí Status: 'approved'
   ‚Üì
5. Auto-create Cart item for user
   ‚Üì
6. User navigates to /cart
   ‚Üì
7. User selects apartments and checkout
   ‚Üì
8. Payment processing ‚Üí User upgraded to 'resident'
   ‚Üì
9. Apartment status updated to 'occupied'
```

### 5. Interactive 3D Building Map

**üìç File:** `frontend/src/pages/buildings/InteractiveBuildingMap.jsx`

```jsx
import React, { useState, useEffect } from 'react';
import { toast } from 'react-hot-toast';
import { MapIcon, BuildingOfficeIcon, HomeIcon } from '@heroicons/react/24/outline';
import { blockAPI, buildingAPI, floorAPI, apartmentAPI } from '../../services/api';
import '../../styles/InteractiveBuildingMap.css';

const InteractiveBuildingMap = () => {
    const { user } = useAuth();
    const [blocks, setBlocks] = useState([]);
    const [selectedBlock, setSelectedBlock] = useState(null);
    const [selectedBuilding, setSelectedBuilding] = useState(null);
    const [selectedFloor, setSelectedFloor] = useState(null);
    const [buildings, setBuildings] = useState([]);
    const [floors, setFloors] = useState([]);
    const [apartments, setApartments] = useState([]);
    const [viewMode, setViewMode] = useState('2d'); // '2d', '3d', 'list'

    // Load blocks on mount
    useEffect(() => {
        const fetchBlocks = async () => {
            try {
                const response = await blockAPI.getAll();
                if (response.data.success) {
                    setBlocks(response.data.data.blocks);
                }
            } catch (error) {
                toast.error('Failed to load blocks');
            }
        };
        fetchBlocks();
    }, []);

    // Load buildings when block selected
    useEffect(() => {
        if (selectedBlock) {
            const fetchBuildings = async () => {
                try {
                    const response = await buildingAPI.getByBlock(selectedBlock.id);
                    if (response.data.success) {
                        setBuildings(response.data.data.buildings);
                    }
                } catch (error) {
                    toast.error('Failed to load buildings');
                }
            };
            fetchBuildings();
        }
    }, [selectedBlock]);

    // Load floors when building selected
    useEffect(() => {
        if (selectedBuilding) {
            const fetchFloors = async () => {
                try {
                    const response = await floorAPI.getByBuilding(selectedBuilding.id);
                    if (response.data.success) {
                        setFloors(response.data.data.floors);
                    }
                } catch (error) {
                    toast.error('Failed to load floors');
                }
            };
            fetchFloors();
        }
    }, [selectedBuilding]);

    // Load apartments when floor selected
    useEffect(() => {
        if (selectedFloor) {
            const fetchApartments = async () => {
                try {
                    const response = await apartmentAPI.getByFloor(selectedFloor.id);
                    if (response.data.success) {
                        setApartments(response.data.data.apartments);
                    }
                } catch (error) {
                    toast.error('Failed to load apartments');
                }
            };
            fetchApartments();
        }
    }, [selectedFloor]);

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
            {/* View Mode Toggle */}
            <div className="mb-6 flex gap-4">
                <button
                    onClick={() => setViewMode('2d')}
                    className={`px-4 py-2 rounded-lg ${
                        viewMode === '2d' ? 'bg-blue-600 text-white' : 'bg-white'
                    }`}
                >
                    2D View
                </button>
                <button
                    onClick={() => setViewMode('3d')}
                    className={`px-4 py-2 rounded-lg ${
                        viewMode === '3d' ? 'bg-blue-600 text-white' : 'bg-white'
                    }`}
                >
                    3D View
                </button>
            </div>

            {/* 3D View */}
            {viewMode === '3d' && (
                <div className="perspective-1500">
                    <div className="transform-style-preserve-3d rotate-x-12 rotate-y-12">
                        {/* Render blocks in 3D */}
                        <div className="grid grid-cols-3 gap-8">
                            {blocks.map((block, idx) => (
                                <div
                                    key={block.id}
                                    className="translate-z-20 transition-transform hover:scale-110 cursor-pointer"
                                    onClick={() => setSelectedBlock(block)}
                                >
                                    <div className="glass-effect rounded-lg p-6">
                                        <MapIcon className="w-12 h-12 mx-auto text-blue-600" />
                                        <h3 className="text-center mt-2">{block.name}</h3>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {/* 2D View */}
            {viewMode === '2d' && (
                <div className="grid grid-cols-4 gap-6">
                    {/* Blocks */}
                    {!selectedBlock && blocks.map(block => (
                        <BlockCard
                            key={block.id}
                            block={block}
                            onClick={() => setSelectedBlock(block)}
                        />
                    ))}

                    {/* Buildings */}
                    {selectedBlock && !selectedBuilding && buildings.map(building => (
                        <BuildingCard
                            key={building.id}
                            building={building}
                            onClick={() => setSelectedBuilding(building)}
                        />
                    ))}

                    {/* Floors */}
                    {selectedBuilding && !selectedFloor && floors.map(floor => (
                        <FloorCard
                            key={floor.id}
                            floor={floor}
                            onClick={() => setSelectedFloor(floor)}
                        />
                    ))}

                    {/* Apartments */}
                    {selectedFloor && apartments.map(apartment => (
                        <ApartmentCard
                            key={apartment.id}
                            apartment={apartment}
                            onClick={() => handleApartmentClick(apartment)}
                        />
                    ))}
                </div>
            )}
        </div>
    );
};

export default InteractiveBuildingMap;
```

**3D CSS Transforms:**
**üìç File:** `frontend/src/styles/InteractiveBuildingMap.css`

```css
.perspective-1500 {
    perspective: 1500px;
}

.transform-style-preserve-3d {
    transform-style: preserve-3d;
}

.rotate-x-12 {
    transform: rotateX(12deg);
}

.rotate-y-12 {
    transform: rotateY(12deg);
}

.translate-z-20 {
    transform: translateZ(20px);
}

.glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.animate-float {
    animation: float 3s ease-in-out infinite;
}
```

### 6. Frontend Routing v·ªõi Protected Routes

**üìç File:** `frontend/src/App.jsx`

```jsx
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { AuthProvider } from './contexts/AuthContext';
import PrivateRoute from './components/PrivateRoute';
import Login from './pages/Login';
import Register from './pages/Register';
import Dashboard from './pages/Dashboard';
import InteractiveBuildingMap from './pages/buildings/InteractiveBuildingMap';
import Marketplace from './pages/marketplace/Marketplace';
import Cart from './pages/cart/Cart';
import MyRequests from './pages/requests/MyRequests';

function App() {
    return (
        <AuthProvider>
            <Router>
                <Routes>
                    {/* Public routes */}
                    <Route path="/login" element={<Login />} />
                    <Route path="/register" element={<Register />} />

                    {/* Public with optional auth */}
                    <Route path="/buildings/map" element={<InteractiveBuildingMap />} />
                    <Route path="/marketplace" element={<Marketplace />} />

                    {/* Protected routes */}
                    <Route 
                        path="/dashboard" 
                        element={
                            <PrivateRoute>
                                <Dashboard />
                            </PrivateRoute>
                        } 
                    />
                    <Route 
                        path="/cart" 
                        element={
                            <PrivateRoute>
                                <Cart />
                            </PrivateRoute>
                        } 
                    />
                    <Route 
                        path="/my-requests" 
                        element={
                            <PrivateRoute>
                                <MyRequests />
                            </PrivateRoute>
                        } 
                    />
                </Routes>
            </Router>
        </AuthProvider>
    );
}

export default App;
```

## üîç C∆° ch·∫ø ho·∫°t ƒë·ªông

### 1. Hierarchical Data Query Flow
```
Frontend Request: GET /api/apartments?buildingId=1
    ‚Üì
Backend Controller: apartment.controller.js
    ‚Üì
Sequelize Query with nested includes:
    Apartment
        ‚Üì include
    Floor (with floorNumber)
        ‚Üì include
    Building (with name, buildingCode)
        ‚Üì include
    Block (with name)
    ‚Üì
Response: Apartments with full hierarchy
```

### 2. 3D Building Map Interaction
```
User visits /buildings/map
    ‚Üì
Load all blocks
    ‚Üì
User clicks Block (e.g., "S")
    ‚Üì
Load buildings in block (S.01-S.10)
    ‚Üì
User clicks Building (e.g., "S.01")
    ‚Üì
Load floors (Floor 1-6)
    ‚Üì
User clicks Floor 3
    ‚Üì
Load apartments on Floor 3 (0301-0306)
    ‚Üì
User clicks Apartment 0305
    ‚Üì
Show apartment details modal
```

### 3. Lease Request to Cart Flow
```
1. User submits lease request (pending)
2. Manager approves request
3. Auto-create Cart item (Cart.js controller)
4. User navigates to /cart
5. User sees approved apartments
6. User selects items and clicks checkout
7. GraphQL mutation: checkoutCart
8. Payment processing
9. User upgraded to 'resident' role
10. Apartment status ‚Üí 'occupied'
11. tenantId/ownerId updated
```

## üí° V√≠ d·ª• c·ª• th·ªÉ

### V√≠ d·ª• 1: Hierarchical Query
```javascript
// Get apartments with full hierarchy
const apartments = await Apartment.findAll({
    include: [
        {
            model: Floor,
            as: 'floor',
            attributes: ['id', 'floorNumber'],
            include: [
                {
                    model: Building,
                    as: 'building',
                    attributes: ['id', 'name', 'buildingCode'],
                    include: [
                        {
                            model: Block,
                            as: 'block',
                            attributes: ['id', 'name']
                        }
                    ]
                }
            ]
        }
    ],
    where: { isActive: true }
});

// Result structure:
{
    id: 105,
    apartmentNumber: "0305",
    floor: {
        floorNumber: 3,
        building: {
            name: "Building S.01",
            buildingCode: "S.01",
            block: {
                name: "Block S"
            }
        }
    }
}
```

### V√≠ d·ª• 2: Role-Based Dashboard Redirect
```jsx
// After login, redirect based on role
const handleLogin = async () => {
    const success = await login(email, password);
    
    if (success) {
        const role = user.role?.name;
        
        if (role === 'admin') {
            navigate('/admin/dashboard');
        } else if (role === 'building_manager') {
            navigate('/manager/buildings');
        } else if (role === 'resident') {
            navigate('/resident/dashboard');
        } else {
            navigate('/dashboard');
        }
    }
};
```

### V√≠ d·ª• 3: Protected Route v·ªõi Multiple Roles
```jsx
// Route ch·ªâ cho admin v√† building manager
<Route 
    path="/buildings/manage" 
    element={
        <PrivateRoute requiredRoles={['admin', 'building_manager']}>
            <BuildingManagement />
        </PrivateRoute>
    } 
/>
```

## üìä Database Seeding

**üìç File:** `backend/src/seeders/index.js`

```javascript
// Seed 10 buildings v·ªõi apartments
const seedDatabase = async () => {
    // Create 1 block
    const block = await Block.create({
        name: 'Block S',
        address: 'Campus Center'
    });

    // Create 10 buildings (S.01 - S.10)
    for (let i = 1; i <= 10; i++) {
        const buildingCode = `S.${String(i).padStart(2, '0')}`;
        const building = await Building.create({
            name: `Building ${buildingCode}`,
            buildingCode,
            blockId: block.id,
            totalFloors: 6
        });

        // Create 6 floors per building
        for (let floorNum = 1; floorNum <= 6; floorNum++) {
            const floor = await Floor.create({
                floorNumber: floorNum,
                buildingId: building.id
            });

            // Create 6 apartments per floor (0101-0606)
            for (let aptNum = 1; aptNum <= 6; aptNum++) {
                const apartmentNumber = `${String(floorNum).padStart(2, '0')}${String(aptNum).padStart(2, '0')}`;
                await Apartment.create({
                    apartmentNumber,
                    floorId: floor.id,
                    type: ['studio', '1bhk', '2bhk', '3bhk'][Math.floor(Math.random() * 4)],
                    area: 500 + Math.random() * 1500,
                    bedrooms: Math.floor(Math.random() * 4) + 1,
                    bathrooms: Math.floor(Math.random() * 3) + 1,
                    monthlyRent: 500 + Math.random() * 2500,
                    salePrice: 50000 + Math.random() * 200000,
                    status: ['for_rent', 'for_sale'][Math.floor(Math.random() * 2)],
                    isListedForRent: true,
                    isListedForSale: false,
                    images: [
                        `https://source.unsplash.com/800x600/?apartment,interior,${i}${floorNum}${aptNum}1`,
                        `https://source.unsplash.com/800x600/?apartment,kitchen,${i}${floorNum}${aptNum}2`,
                        `https://source.unsplash.com/800x600/?apartment,bedroom,${i}${floorNum}${aptNum}3`
                    ]
                });
            }
        }
    }

    console.log('‚úÖ Database seeded: 10 buildings, 60 floors, 360 apartments');
};
```

## üéØ K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c

| Ti√™u ch√≠ | Tr·∫°ng th√°i | Ghi ch√∫ |
|----------|-----------|---------|
| Hierarchical Data Model | ‚úÖ Ho√†n th√†nh | Block‚ÜíBuilding‚ÜíFloor‚ÜíApartment |
| RBAC System | ‚úÖ Ho√†n th√†nh | 7 roles v·ªõi granular permissions |
| 4-Layer Security | ‚úÖ Ho√†n th√†nh | Rate limit + Helmet + Validation + Auth |
| JWT Authentication | ‚úÖ Ho√†n th√†nh | Access tokens v·ªõi refresh |
| 3D Building Map | ‚úÖ Ho√†n th√†nh | CSS 3D transforms |
| Marketplace | ‚úÖ Ho√†n th√†nh | Browse, filter, request leases |
| Lease Request Workflow | ‚úÖ Ho√†n th√†nh | Pending ‚Üí Approved ‚Üí Cart |
| Database Seeding | ‚úÖ Ho√†n th√†nh | 10 buildings, 360 apartments |
| Protected Routes | ‚úÖ Ho√†n th√†nh | Frontend + backend protection |
| Sequelize Associations | ‚úÖ Ho√†n th√†nh | Complex nested includes |

## üöÄ L·ªánh ch·∫°y project

```bash
# Backend
cd lab05_ManageBuilding/backend
npm install

# Seed database (t·∫°o 10 buildings v·ªõi apartments)
npm run seed

# Run development server
npm run dev     # Port 5000 ho·∫∑c 5001

# Frontend (new terminal)
cd lab05_ManageBuilding/frontend
npm install
npm run dev     # Vite dev server
```

**Environment Variables (.env):**
```env
# Backend
PORT=5000
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=lab05_building_management
JWT_SECRET=your_jwt_secret_key
CLIENT_URL=http://localhost:3000

# Frontend
VITE_API_URL=http://localhost:5000/api
```

## üìö ƒêi·ªÉm m·∫°nh c·ªßa implementation

1. **Hierarchical Architecture**: C·∫•u tr√∫c ph√¢n c·∫•p r√µ r√†ng, d·ªÖ scale
2. **Comprehensive RBAC**: 7 roles v·ªõi fine-grained permissions
3. **4-Layer Security**: Defense in depth approach
4. **3D Visualization**: Modern UI v·ªõi CSS 3D transforms
5. **Guest Access**: Marketplace supports unauthenticated users
6. **Lease Workflow**: Complete workflow from request to checkout
7. **Sequelize Associations**: Proper foreign keys v√† nested includes
8. **Type Safety**: Data validation at model v√† controller levels
9. **Error Handling**: Comprehensive error messages
10. **Scalability**: Clean separation of concerns, easy to extend

---

**Ng√†y ho√†n th√†nh:** Th√°ng 12/2024  
**Sinh vi√™n th·ª±c hi·ªán:** Hu·ª≥nh Thanh Duy - 22110118
